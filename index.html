<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="None">
  
  
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>JUDI documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Home";
    var mkdocs_page_input_path = "index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script>
  <script src="js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="." class="icon icon-home"> JUDI documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href=".">Home</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#installation-and-prerequisites">Installation and prerequisites</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#running-with-docker">Running with Docker</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configure-compiler-and-openmp">Configure compiler and OpenMP</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#full-waveform-inversion">Full-waveform inversion</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#least-squares-reverse-time-migration">Least squares reverse-time migration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#machine-learning">Machine Learning</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#authors">Authors</a>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">JUDI Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="tutorials/full_waveform_inversion/">Acoustic FWI</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tutorials/fwi_example_NLopt/">Acoustic RTM with NLopt</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tutorials/judi_leading_edge_tutorial/">FWI tutorial with JUDI (TLE tuto)</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href=".">JUDI documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".">Docs</a> &raquo;</li>
    
      
    
    <li>Home</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="the-julia-devito-inversion-framework-judi">The Julia Devito Inversion framework (JUDI)</h1>
<p><a href="https://github.com/slimgroup/JUDI.jl/actions?query=workflow%3ACI-tests"><img alt="Build Status " src="https://github.com/slimgroup/JUDI.jl/workflows/CI-tests/badge.svg" /></a></p>
<h2 id="overview">Overview</h2>
<p>JUDI is a framework for large-scale seismic modeling and inversion and designed to enable rapid translations of algorithms to fast and efficient code that scales to industry-size 3D problems. The focus of the package lies on seismic modeling as well as PDE-constrained optimization such as full-waveform inversion (FWI) and imaging (LS-RTM). Wave equations in JUDI are solved with <a href="https://www.devitoproject.org">Devito</a>, a Python domain-specific language for automated finite-difference (FD) computations. JUDI's modeling operators can also be used as layers in (convolutional) neural networks to implement physics-augmented deep learning algorithms. For this, check out JUDI's deep learning extension <a href="https://github.com/slimgroup/JUDI4Flux.jl">JUDI4Flux</a>.</p>
<h2 id="installation-and-prerequisites">Installation and prerequisites</h2>
<p>First, install Devito using <code>pip</code>, or see the <a href="https://github.com/devitocodes/devito">Devito's GitHub page</a> for installation with Conda and further information. The current release of JUDI requires Python 3 and the current Devito version. Run all of the following commands from the (bash) terminal command line (not in the Julia REPL):</p>
<div class="highlight"><pre><span></span><code><span class="n">pip3</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">devitocodes</span><span class="o">/</span><span class="n">devito</span><span class="o">.</span><span class="n">git</span>
</code></pre></div>

<p>For reading and writing seismic SEG-Y data, JUDI uses the <a href="https://github.com/slimgroup/SegyIO.jl">SegyIO</a> package and matrix-free linear operators are based the <a href="https://github.com/slimgroup/JOLI.jl/tree/master/src">Julia Operator LIbrary</a> (JOLI):</p>
<div class="highlight"><pre><span></span><code><span class="n">julia</span> <span class="o">-</span><span class="nb">e</span> <span class="err">&#39;</span><span class="k">using</span> <span class="n">Pkg</span><span class="p">;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="s">&quot;https://github.com/slimgroup/SegyIO.jl.git&quot;</span><span class="p">)</span><span class="o">&#39;</span>
<span class="n">julia</span> <span class="o">-</span><span class="nb">e</span> <span class="err">&#39;</span><span class="k">using</span> <span class="n">Pkg</span><span class="p">;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="s">&quot;https://github.com/slimgroup/JOLI.jl.git&quot;</span><span class="p">)</span><span class="o">&#39;</span>
</code></pre></div>

<p>Once Devito, SegyIO and JOLI are installed, you can install JUDI with Julia's <code>Pkg.clone</code>. For Devito 3.2.0, it is also necessary to install some Devito dependencies by hand:</p>
<div class="highlight"><pre><span></span><code><span class="n">julia</span> <span class="o">-</span><span class="nb">e</span> <span class="err">&#39;</span><span class="k">using</span> <span class="n">Pkg</span><span class="p">;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="s">&quot;https://github.com/slimgroup/JUDI.jl&quot;</span><span class="p">)</span><span class="o">&#39;</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">-</span><span class="n">r</span> <span class="o">~/.</span><span class="n">julia</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">JUDI</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">devito_requirements</span><span class="o">.</span><span class="n">txt</span>
</code></pre></div>

<p>Once you have JUDI installed, you need to point Julia's PyCall package to the Python version for which we previsouly installed Devito. To do this, copy-paste the following commands into the (bash) terminal:</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span> <span class="n">PYTHON</span><span class="o">=$</span><span class="p">(</span><span class="n">which</span> <span class="n">python</span><span class="p">)</span>
<span class="n">julia</span> <span class="o">-</span><span class="nb">e</span> <span class="err">&#39;</span><span class="k">using</span> <span class="n">Pkg</span><span class="p">;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s">&quot;PyCall&quot;</span><span class="p">)</span><span class="o">&#39;</span>
</code></pre></div>

<h2 id="running-with-docker">Running with Docker</h2>
<p>If you do not want to install JUDI, you can run JUDI as a docker image. The first possibility is to run the docker container as a Jupyter notebook:</p>
<div class="highlight"><pre><span></span><code>docker run -p 8888:8888 philippwitte/judi:v1.1
</code></pre></div>

<p>This command downloads the image and launches a container. You will see a link that you can copy-past to your browser to access the notebooks. Alternatively, you can run a bash session, in which you can start a regular interactive Julia session and run the example scripts. Download/start the container as a bash session with:</p>
<div class="highlight"><pre><span></span><code>docker run -it philippwitte/judi:v1.1 /bin/bash
</code></pre></div>

<p>Inside the container, all examples are located in the directory <code>/app/judi/examples/scripts</code>.</p>
<h2 id="configure-compiler-and-openmp">Configure compiler and OpenMP</h2>
<p>Devito uses just-in-time compilation for the underlying wave equation solves. The default compiler is intel, but can be changed to any other specified compiler such as <code>gnu</code>. Either run the following command from the command line or add it to your ~/.bashrc file:</p>
<div class="highlight"><pre><span></span><code>export DEVITO_ARCH=gnu
</code></pre></div>

<p>Devito uses shared memory OpenMP parallelism for solving PDEs. OpenMP is disabled by default, but you can enable OpenMP and define the number of threads (per PDE solve) as follows:</p>
<div class="highlight"><pre><span></span><code>export DEVITO_OPENMP=1  # Enable OpenMP. Set to 0 to disable again.
export OMP_NUM_THREADS=4    # Number of OpenMP threads
</code></pre></div>

<h2 id="full-waveform-inversion">Full-waveform inversion</h2>
<p>JUDI is designed to let you set up objective functions that can be passed to standard packages for (gradient-based) optimization. The following example demonstrates how to perform FWI on the 2D Overthrust model using a spectral projected gradient algorithm from the minConf library, which is included in the software. A small test dataset (62 MB) and the model can be downloaded from this FTP server:</p>
<div class="highlight"><pre><span></span><code><span class="n">run</span><span class="p">(</span><span class="sb">`wget ftp://slim.gatech.edu/data/SoftwareRelease/WaveformInversion.jl/2DFWI/overthrust_2D.segy`</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="sb">`wget ftp://slim.gatech.edu/data/SoftwareRelease/WaveformInversion.jl/2DFWI/overthrust_2D_initial_model.h5`</span><span class="p">)</span>
</code></pre></div>

<p>The first step is to load the velocity model and the observed data into Julia, as well as setting up bound constraints for the inversion, which prevent too high or low velocities in the final result. Furthermore, we define an 8 Hertz Ricker wavelet as the source function:</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span> <span class="n">PyPlot</span><span class="p">,</span> <span class="n">HDF5</span><span class="p">,</span> <span class="n">SegyIO</span><span class="p">,</span> <span class="n">JUDI</span><span class="o">.</span><span class="n">TimeModeling</span><span class="p">,</span> <span class="n">JUDI</span><span class="o">.</span><span class="n">SLIM_optim</span><span class="p">,</span> <span class="n">Statistics</span><span class="p">,</span> <span class="n">Random</span>

<span class="c"># Load starting model</span>
<span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">h5open</span><span class="p">(</span><span class="s">&quot;overthrust_2D_initial_model.h5&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">),</span> <span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> <span class="s">&quot;m0&quot;</span><span class="p">)</span>
<span class="n">model0</span> <span class="o">=</span> <span class="n">Model</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">m0</span><span class="p">)</span>    <span class="c"># need n, d, o as tuples and m0 as array</span>

<span class="c"># Bound constraints</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">.+</span> <span class="mf">0.3f0</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">.+</span> <span class="mf">5.5f0</span>
<span class="n">mmin</span> <span class="o">=</span> <span class="n">vec</span><span class="p">((</span><span class="mf">1f0</span> <span class="o">./</span> <span class="n">vmax</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># convert to slowness squared [s^2/km^2]</span>
<span class="n">mmax</span> <span class="o">=</span> <span class="n">vec</span><span class="p">((</span><span class="mf">1f0</span> <span class="o">./</span> <span class="n">vmin</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span>

<span class="c"># Load segy data</span>
<span class="n">block</span> <span class="o">=</span> <span class="n">segy_read</span><span class="p">(</span><span class="s">&quot;overthrust_2D.segy&quot;</span><span class="p">)</span>
<span class="n">dobs</span> <span class="o">=</span> <span class="n">judiVector</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

<span class="c"># Set up wavelet</span>
<span class="n">src_geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">block</span><span class="p">;</span> <span class="n">key</span><span class="o">=</span><span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">segy_depth_key</span><span class="o">=</span><span class="s">&quot;SourceDepth&quot;</span><span class="p">)</span>  <span class="c"># read source position geometry</span>
<span class="n">wavelet</span> <span class="o">=</span> <span class="n">ricker_wavelet</span><span class="p">(</span><span class="n">src_geometry</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src_geometry</span><span class="o">.</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.008f0</span><span class="p">)</span>    <span class="c"># 8 Hz wavelet</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">judiVector</span><span class="p">(</span><span class="n">src_geometry</span><span class="p">,</span> <span class="n">wavelet</span><span class="p">)</span>
</code></pre></div>

<p>For this FWI example, we define an objective function that can be passed to the minConf optimization library, which is included in the Julia Devito software package. We allow a maximum of 20 function evaluations using a spectral-projected gradient (SPG) algorithm. To save computational cost, each function evaluation uses a randomized subset of 20 shot records, instead of all 97 shots:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Optimization parameters</span>
<span class="n">fevals</span> <span class="o">=</span> <span class="mi">20</span> <span class="c"># number of function evaluations</span>
<span class="n">batchsize</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c"># number of sources per iteration</span>
<span class="n">fvals</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">optimal_checkpointing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>    <span class="c"># set to true to enable checkpointing</span>

<span class="c"># Objective function for minConf library</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">function</span> <span class="n">objective_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">model0</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">);</span>

    <span class="c"># fwi function value and gradient</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">randperm</span><span class="p">(</span><span class="n">dobs</span><span class="o">.</span><span class="n">nsrc</span><span class="p">)[</span><span class="mi">1</span><span class="o">:</span><span class="n">batchsize</span><span class="p">]</span>
    <span class="n">fval</span><span class="p">,</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">fwi_objective</span><span class="p">(</span><span class="n">model0</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dobs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">options</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">);</span> <span class="n">grad</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span><span class="mi">21</span><span class="p">]</span> <span class="o">.=</span> <span class="mf">0f0</span>    <span class="c"># reset gradient in water column to 0.</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="o">.</span><span class="mf">1f0</span><span class="o">*</span><span class="n">grad</span><span class="o">/</span><span class="n">maximum</span><span class="p">(</span><span class="n">abs</span><span class="o">.</span><span class="p">(</span><span class="n">grad</span><span class="p">))</span>    <span class="c"># scale gradient for line search</span>

    <span class="kd">global</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">fvals</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">fval</span>
    <span class="k">return</span> <span class="n">fval</span><span class="p">,</span> <span class="n">vec</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># FWI with SPG</span>
<span class="n">ProjBound</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">median</span><span class="p">([</span><span class="n">mmin</span> <span class="n">x</span> <span class="n">mmax</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># Bound projection</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">spg_options</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="n">fevals</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">fsave</span><span class="p">,</span> <span class="n">funEvals</span><span class="o">=</span> <span class="n">minConf_SPG</span><span class="p">(</span><span class="n">objective_function</span><span class="p">,</span> <span class="n">vec</span><span class="p">(</span><span class="n">model0</span><span class="o">.</span><span class="n">m</span><span class="p">),</span> <span class="n">ProjBound</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</code></pre></div>

<p>This example script can be run in parallel and requires roughly 220 MB of memory per source location. Execute the following code to generate figures of the initial model and the result, as well as the function values:</p>
<div class="highlight"><pre><span></span><code><span class="n">figure</span><span class="p">();</span> <span class="n">imshow</span><span class="p">(</span><span class="n">sqrt</span><span class="o">.</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">adjoint</span><span class="p">(</span><span class="n">m0</span><span class="p">)));</span> <span class="n">title</span><span class="p">(</span><span class="s">&quot;Initial model&quot;</span><span class="p">)</span>
<span class="n">figure</span><span class="p">();</span> <span class="n">imshow</span><span class="p">(</span><span class="n">sqrt</span><span class="o">.</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">adjoint</span><span class="p">(</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">))));</span> <span class="n">title</span><span class="p">(</span><span class="s">&quot;FWI&quot;</span><span class="p">)</span>
<span class="n">figure</span><span class="p">();</span> <span class="n">plot</span><span class="p">(</span><span class="n">fvals</span><span class="p">);</span> <span class="n">title</span><span class="p">(</span><span class="s">&quot;Function value&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="docs/img/fwi.png" /></p>
<h2 id="least-squares-reverse-time-migration">Least squares reverse-time migration</h2>
<p>JUDI includes matrix-free linear operators for modeling and linearized (Born) modeling, that let you write algorithms for migration that follow the mathematical notation of standard least squares problems. This example demonstrates how to use Julia Devito to perform least-squares reverse-time migration on the 2D Marmousi model. Start by downloading the test data set (1.1 GB) and the model:</p>
<div class="highlight"><pre><span></span><code><span class="n">run</span><span class="p">(</span><span class="sb">`wget ftp://slim.gatech.edu/data/SoftwareRelease/Imaging.jl/2DLSRTM/marmousi_2D.segy`</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="sb">`wget ftp://slim.gatech.edu/data/SoftwareRelease/Imaging.jl/2DLSRTM/marmousi_migration_velocity.h5`</span><span class="p">)</span>
</code></pre></div>

<p>Once again, load the starting model and the data and set up the source wavelet. For this example, we use a Ricker wavelet with 30 Hertz peak frequency. For setting up matrix-free linear operators, an <code>info</code> structure with the dimensions of the problem is required:</p>
<div class="highlight"><pre><span></span><code><span class="k">using</span> <span class="n">PyPlot</span><span class="p">,</span> <span class="n">HDF5</span><span class="p">,</span> <span class="n">JUDI</span><span class="o">.</span><span class="n">TimeModeling</span><span class="p">,</span> <span class="n">SegyIO</span><span class="p">,</span> <span class="n">Random</span>

<span class="c"># Load smooth migration velocity model</span>
<span class="n">n</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">m0</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">h5open</span><span class="p">(</span><span class="s">&quot;marmousi_migration_velocity.h5&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">),</span> <span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> <span class="s">&quot;m0&quot;</span><span class="p">)</span>
<span class="n">model0</span> <span class="o">=</span> <span class="n">Model</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">m0</span><span class="p">)</span>

<span class="c"># Load data</span>
<span class="n">block</span> <span class="o">=</span> <span class="n">segy_read</span><span class="p">(</span><span class="s">&quot;marmousi_2D.segy&quot;</span><span class="p">)</span>
<span class="n">dD</span> <span class="o">=</span> <span class="n">judiVector</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

<span class="c"># Set up wavelet</span>
<span class="n">src_geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">block</span><span class="p">;</span> <span class="n">key</span><span class="o">=</span><span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="n">segy_depth_key</span><span class="o">=</span><span class="s">&quot;SourceDepth&quot;</span><span class="p">)</span>
<span class="n">wavelet</span> <span class="o">=</span> <span class="n">ricker_wavelet</span><span class="p">(</span><span class="n">src_geometry</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">src_geometry</span><span class="o">.</span><span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.03</span><span class="p">)</span> <span class="c"># 30 Hz wavelet</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">judiVector</span><span class="p">(</span><span class="n">src_geometry</span><span class="p">,</span><span class="n">wavelet</span><span class="p">)</span>

<span class="c"># Set up info structure</span>
<span class="n">ntComp</span> <span class="o">=</span> <span class="n">get_computational_nt</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span><span class="n">dD</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span><span class="n">model0</span><span class="p">)</span>    <span class="c"># no. of computational time steps</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">Info</span><span class="p">(</span><span class="n">prod</span><span class="p">(</span><span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">),</span><span class="n">dD</span><span class="o">.</span><span class="n">nsrc</span><span class="p">,</span><span class="n">ntComp</span><span class="p">)</span>
</code></pre></div>

<p>To speed up the convergence of our imaging example, we set up a basic preconditioner for each the model- and the data space, consisting of mutes to suppress the ocean-bottom reflection in the data and the source/receiver imprint in the image. The operator <code>J</code> represents the linearized modeling operator and its adjoint <code>J'</code> corresponds to the migration (RTM) operator. The forward and adjoint pair can be used for a basic LS-RTM example with (stochastic) gradient descent:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Set up matrix-free linear operators</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">optimal_checkpointing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>    <span class="c"># set to false to disable optimal checkpointing</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">judiModeling</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">model0</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">dD</span><span class="o">.</span><span class="n">geometry</span><span class="p">;</span> <span class="n">options</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">judiJacobian</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

<span class="c"># Right-hand preconditioners (model topmute)</span>
<span class="n">Mr</span> <span class="o">=</span> <span class="n">judiTopmute</span><span class="p">(</span><span class="n">model0</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c"># mute up to grid point 52, with 10 point taper</span>

<span class="c"># Stochastic gradient</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>  <span class="c"># zero initial guess</span>
<span class="n">batchsize</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c"># use subset of 10 shots per iteration</span>
<span class="n">niter</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">fval</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">niter</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="n">niter</span>
    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Iteration: &quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="c"># Select batch and set up left-hand preconditioner</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">randperm</span><span class="p">(</span><span class="n">dD</span><span class="o">.</span><span class="n">nsrc</span><span class="p">)[</span><span class="mi">1</span><span class="o">:</span><span class="n">batchsize</span><span class="p">]</span>
    <span class="n">Ml</span> <span class="o">=</span> <span class="n">judiMarineTopmute2D</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">dD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>    <span class="c"># data topmute starting at time sample 30</span>

    <span class="c"># Compute residual and gradient</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Ml</span><span class="o">*</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Mr</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">Ml</span><span class="o">*</span><span class="n">dD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">adjoint</span><span class="p">(</span><span class="n">Mr</span><span class="p">)</span><span class="o">*</span><span class="n">adjoint</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">adjoint</span><span class="p">(</span><span class="n">Ml</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>

    <span class="c"># Step size and update variable</span>
    <span class="n">fval</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mf">5f0</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
    <span class="kd">global</span> <span class="n">x</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">g</span>
<span class="k">end</span>
</code></pre></div>

<p><img alt="" src="docs/img/lsrtm.png" /></p>
<h2 id="machine-learning">Machine Learning</h2>
<p>The JUDI4Flux interface allows integrating JUDI modeling operators into convolutional neural networks for deep learning. For example, the following code snippet shows how to create a shallow CNN consisting of two convolutional layers with a nonlinear forward modeling layer in-between them. JUDI4Flux enables backpropagation through Flux' automatic differentiation tool, but calls the corresponding adjoint JUDI operators under the hood. For more details, please check out the <a href="https://github.com/slimgroup/JUDI4Flux.jl">JUDI4Flux Github</a> page.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Nonlinear JUDI modeling operator</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">judiModeling</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">rec_geometry</span><span class="p">,</span> <span class="n">src_geometry</span><span class="p">)</span>

<span class="c"># Network layers</span>
<span class="n">ℱ</span> <span class="o">=</span> <span class="n">ForwardModel</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Network and loss</span>
<span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv2</span><span class="p">(</span><span class="n">ℱ</span><span class="p">(</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="n">loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>

<span class="c"># Compute gradient w/ Flux</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">gradient</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">params</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="n">gs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>   <span class="c"># evalute gradient w.r.t. m</span>
</code></pre></div>

<p>JUDI4Flux allows implementing physics-augmented neural networks for seismic inversion, such as loop-unrolled seismic imaging algorithms. For example, the following results are a conventional RTM image, an LS-RTM image and a loop-unrolled LS-RTM image for a single simultaneous shot record.</p>
<p><img alt="" src="docs/img/figure1.png" /></p>
<h2 id="authors">Authors</h2>
<p>This package was written by <a href="https://www.slim.eos.ubc.ca/philip">Philipp Witte</a> and <a href="https://www.slim.eos.ubc.ca/content/mathias-louboutin">Mathias Louboutin</a> from the Seismic Laboratory for Imaging and Modeling (SLIM) at the Georgia Institute of Technology.</p>
<p>If you use our software for your research, please cite our <a href="https://library.seg.org/doi/abs/10.1190/geo2018-0174.1#">Geophysics paper</a>:</p>
<div class="highlight"><pre><span></span><code>@article{witteJUDI2019,
author = {Philipp A. Witte and Mathias Louboutin and Navjot Kukreja and Fabio Luporini and Michael Lange and Gerard J. Gorman and Felix J. Herrmann},
title = {A large-scale framework for symbolic implementations of seismic inversion algorithms in Julia},
journal = {GEOPHYSICS},
volume = {84},
number = {3},
pages = {F57-F71},
year = {2019},
doi = {10.1190/geo2018-0174.1},
URL = {https://doi.org/10.1190/geo2018-0174.1},
eprint = {https://doi.org/10.1190/geo2018-0174.1}
}
</code></pre></div>

<p>Also visit the Devito homepage at <a href="https://www.devitoproject.org/publications">https://www.devitoproject.org/publications</a> for more information and references.</p>
<p>Contact authors via: <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#112;&#119;&#105;&#116;&#116;&#101;&#51;&#64;&#103;&#97;&#116;&#101;&#99;&#104;&#46;&#101;&#100;&#117;">&#112;&#119;&#105;&#116;&#116;&#101;&#51;&#64;&#103;&#97;&#116;&#101;&#99;&#104;&#46;&#101;&#100;&#117;</a> and <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#109;&#108;&#111;&#117;&#98;&#111;&#117;&#116;&#105;&#110;&#51;&#64;&#103;&#97;&#116;&#101;&#99;&#104;&#46;&#101;&#100;&#117;">&#109;&#108;&#111;&#117;&#98;&#111;&#117;&#116;&#105;&#110;&#51;&#64;&#103;&#97;&#116;&#101;&#99;&#104;&#46;&#101;&#100;&#117;</a>.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorials/full_waveform_inversion/" class="btn btn-neutral float-right" title="Acoustic FWI">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
        <span style="margin-left: 15px"><a href="tutorials/full_waveform_inversion/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme.js" defer></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!--
MkDocs version : 1.1
Build Date UTC : 2020-03-11 18:39:56
-->
